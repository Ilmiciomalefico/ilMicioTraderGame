<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ilMicioTrader - Mobile Edition</title>
    <style>
        :root { --neon: #00ff88; --red: #ff3366; --gold: #fbbf24; --bg: #050608; --ai-blue: #4285f4; }
        body { margin: 0; background: var(--bg); color: #fff; font-family: 'Courier New', sans-serif; overflow: hidden; touch-action: none; }
        
        #game-ui { position: absolute; inset: 0; pointer-events: none; z-index: 10; display: none; }
        #start-screen { position: absolute; inset: 0; background: var(--bg); display: flex; flex-direction: column; align-items: center; justify-content: center; z-index: 100; text-align: center; }
        
        .panel { background: rgba(15, 23, 42, 0.9); padding: 15px; border: 1px solid #334155; backdrop-filter: blur(10px); border-radius: 12px; }
        .stats-top { position: absolute; top: 10px; left: 10px; right: 10px; display: flex; justify-content: space-between; align-items: center; }
        
        /* MOBILE CONTROLS */
        #controls { 
            position: absolute; bottom: 30px; left: 0; width: 100%; 
            display: flex; justify-content: space-evenly; pointer-events: auto; z-index: 20; 
        }
        .trade-btn {
            width: 40%; padding: 20px; border-radius: 15px; border: 2px solid rgba(255,255,255,0.1);
            font-weight: 900; font-size: 1.2rem; color: white; cursor: pointer; text-transform: uppercase;
            transition: 0.2s; background: rgba(0,0,0,0.5);
        }
        #btn-long { border-color: var(--neon); color: var(--neon); }
        #btn-short { border-color: var(--red); color: var(--red); }
        
        .active-long { background: var(--neon) !important; color: black !important; box-shadow: 0 0 20px var(--neon); }
        .active-short { background: var(--red) !important; color: white !important; box-shadow: 0 0 20px var(--red); }

        #xp-bar { width: 100px; height: 6px; background: #1e293b; border-radius: 3px; overflow: hidden; margin-top: 5px; }
        #xp-fill { height: 100%; background: var(--gold); width: 0%; transition: width 0.3s; }

        .price-up { color: var(--neon); }
        .price-down { color: var(--red); }
        canvas { display: block; }
    </style>
</head>
<body>

    <div id="start-screen">
        <h1 style="font-size: 2rem; letter-spacing: 3px;">IL MICIO TRADER</h1>
        <button class="trade-btn" style="width:auto; border-color: var(--ai-blue); color: var(--ai-blue);" onclick="startGame()">ENTER MARKET</button>
        <p style="font-size: 0.7rem; color: #475569; margin-top: 20px;">[ MOBILE & DESKTOP READY ]</p>
    </div>

    <div id="game-ui">
        <div class="stats-top panel">
            <div>
                <div id="balance" style="font-size: 1.2rem; font-weight: 900;">$10,000.00</div>
                <div id="xp-bar"><div id="xp-fill"></div></div>
            </div>
            <div style="text-align: right;">
                <div id="btc-price" style="font-size: 1.1rem; font-weight: bold; color: var(--neon);">--</div>
                <div id="pnl" style="font-size: 0.8rem;">P/L: $0.00</div>
            </div>
        </div>

        <div id="controls">
            <button id="btn-long" class="trade-btn active-long" onclick="setDirection(true)">LONG</button>
            <button id="btn-short" class="trade-btn" onclick="setDirection(false)">SHORT</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, points = [], currentPrice = 0, catY = 0;
        let balance = 10000, pnl = 0, level = 1, leverage = 5, xp = 0, isLong = true;
        let isStarted = false;
        let ema9 = 0;

        function startGame() {
            document.getElementById('start-screen').style.display = 'none';
            document.getElementById('game-ui').style.display = 'block';
            isStarted = true;
            initWS();
            resize();
        }

        function setDirection(long) {
            isLong = long;
            document.getElementById('btn-long').className = 'trade-btn' + (isLong ? ' active-long' : '');
            document.getElementById('btn-short').className = 'trade-btn' + (!isLong ? ' active-short' : '');
        }

        function initWS() {
            const ws = new WebSocket('wss://ws.bitget.com/v2/ws/public');
            ws.onopen = () => ws.send(JSON.stringify({
                "op": "subscribe",
                "args": [{"instType": "SPOT", "channel": "ticker", "instId": "BTCUSDT"}]
            }));
            ws.onmessage = (e) => {
                const d = JSON.parse(e.data);
                if (d.data && d.data[0]) processMarketData(parseFloat(d.data[0].lastPr));
            };
        }

        function processMarketData(price) {
            if (currentPrice) {
                ema9 = (price - ema9) * (2/10) + ema9;
                const change = (price - currentPrice) / currentPrice;
                const move = (balance + pnl) * change * leverage * (isLong ? 1 : -1);
                pnl += move;

                if ((isLong && price > ema9) || (!isLong && price < ema9)) {
                    xp += 2;
                    if (xp > level * 100) levelUp();
                }
                if (balance + pnl <= 0) { alert("LIQUIDATED!"); location.reload(); }
            } else { ema9 = price; }
            currentPrice = price;
            points.push(price);
            if (points.length > 80) points.shift();
            updateUI();
        }

        function levelUp() {
            level++; leverage += 5; xp = 0;
            // Lahko dodaÅ¡ kakÅ¡en vizualen efekt ob level upu
        }

        function updateUI() {
            document.getElementById('balance').innerText = "$" + (balance + pnl).toLocaleString(undefined,{minimumFractionDigits:2});
            const pnlEl = document.getElementById('pnl');
            pnlEl.innerText = `P/L: ${pnl>=0?"+":""}${pnl.toFixed(2)}`;
            pnlEl.className = pnl >= 0 ? "price-up" : "price-down";
            document.getElementById('btc-price').innerText = currentPrice.toFixed(2);
            document.getElementById('xp-fill').style.width = (xp / (level * 100) * 100) + "%";
        }

        function resize() {
            width = canvas.width = window.innerWidth;
            height = canvas.height = window.innerHeight;
        }
        window.onresize = resize;

        function drawMicio(x, y) {
            ctx.save();
            ctx.translate(x, y);
            const glow = isLong ? "#00ff88" : "#ff3366";
            ctx.shadowBlur = 20;
            ctx.shadowColor = glow;
            ctx.fillStyle = "#111";
            ctx.beginPath();
            ctx.arc(0, 0, 25, 0, Math.PI * 2);
            ctx.fill();
            ctx.strokeStyle = glow;
            ctx.lineWidth = 3;
            ctx.stroke();
            // Emoji eyes
            ctx.font = "20px Arial";
            ctx.textAlign = "center";
            ctx.fillText(level >= 3 ? "ðŸ•¶ï¸" : "ðŸ±", 0, 7);
            ctx.restore();
        }

        function render() {
            if (!isStarted) { requestAnimationFrame(render); return; }
            ctx.fillStyle = "#050608";
            ctx.fillRect(0, 0, width, height);

            if (points.length > 2) {
                const min = Math.min(...points), max = Math.max(...points), range = (max-min)||20;
                const getY = (p) => height/2 + (height/4) * (-(p - (min+max)/2) / (range/2));
                const spacing = width / 80;

                ctx.beginPath();
                ctx.lineWidth = 3;
                ctx.strokeStyle = isLong ? "#00ff88" : "#ff3366";
                points.forEach((p, i) => { 
                    const x = i * spacing;
                    const y = getY(p);
                    if(i==0) ctx.moveTo(x, y); else ctx.lineTo(x, y); 
                });
                ctx.stroke();

                const targetY = getY(points[points.length-1]);
                catY += (targetY - catY) * 0.1;
                drawMicio((points.length-1) * spacing, catY);
            }
            requestAnimationFrame(render);
        }
        render();
    </script>
</body>
</html>
