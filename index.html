<!DOCTYPE html>
<html lang="sl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ilMicioTraderGame - Cyber Evolution</title>
    <style>
        :root {
            --neon: #00ff88;
            --danger: #ff3366;
            --gold: #fbbf24;
        }
        body { margin: 0; background: #050608; color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        
        #ui {
            position: absolute; top: 20px; left: 20px; z-index: 100;
            background: rgba(0,0,0,0.7); padding: 15px; border-radius: 10px;
            border-left: 4px solid var(--neon); backdrop-filter: blur(5px);
        }

        .stat { font-family: monospace; font-size: 1.2rem; margin-bottom: 5px; }
        .lvl-badge { color: var(--gold); font-weight: bold; }
        
        #overlay {
            position: absolute; inset: 0; background: rgba(0,0,0,0.9);
            display: none; flex-direction: column; align-items: center; justify-content: center;
            z-index: 1000;
        }

        button { 
            background: var(--neon); border: none; padding: 15px 30px; 
            font-weight: bold; cursor: pointer; border-radius: 5px; margin-top: 20px;
        }
    </style>
</head>
<body>

    <div id="overlay">
        <h1 style="color: var(--danger); font-size: 4rem;">LIQUIDATED</h1>
        <button onclick="location.reload()">RETRY WITH $10,000</button>
    </div>

    <div id="ui">
        <div class="stat">RANK: <span id="lvl" class="lvl-badge">LVL 1 (Bajso)</span></div>
        <div class="stat">EQUITY: <span id="bal">$10,000.00</span></div>
        <div class="stat" id="pnl" style="font-size: 0.9rem;">P/L: $0.00</div>
        <div class="stat" style="font-size: 0.8rem; color: #64748b;">LEV: <span id="lev">5x</span></div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        let width, height, points = [], currentPrice = 0, catY = 0;
        let balance = 10000, pnl = 0, level = 1, leverage = 5, xp = 0, isLong = false;

        const ws = new WebSocket('wss://ws.bitget.com/v2/ws/public');
        ws.onopen = () => ws.send(JSON.stringify({"op": "subscribe","args": [{"instType": "SPOT", "channel": "ticker", "instId": "BTCUSDT"}]}));
        ws.onmessage = (e) => {
            const d = JSON.parse(e.data);
            if (d.data && d.data[0]) {
                const price = parseFloat(d.data[0].lastPr);
                if (currentPrice) {
                    const change = (price - currentPrice) / currentPrice;
                    const move = balance * change * leverage * (isLong ? 1 : -1);
                    pnl += move;
                    if (move > 0) { xp++; if (xp > level * 40) levelUp(); }
                    if (balance + pnl <= 0) document.getElementById('overlay').style.display = 'flex';
                }
                currentPrice = price;
                points.push(price); if (points.length > 100) points.shift();
                updateUI();
            }
        };

        function levelUp() {
            level++; leverage += 5; xp = 0;
            const titles = ["Bajso", "Hustler", "Bully", "Alpha", "GigaMicio"];
            document.getElementById('lvl').innerText = `LVL ${level} (${titles[Math.min(level-1, 4)]})`;
        }

        function updateUI() {
            document.getElementById('bal').innerText = "$" + (balance + pnl).toLocaleString(undefined,{minimumFractionDigits:2});
            document.getElementById('pnl').innerText = "P/L: " + (pnl>=0?"+":"") + pnl.toFixed(2);
            document.getElementById('pnl').style.color = pnl>=0 ? "#00ff88" : "#ff3366";
            document.getElementById('lev').innerText = leverage + "x";
        }

        function resize() { width = window.innerWidth; height = window.innerHeight; canvas.width = width; canvas.height = height; }
        window.onresize = resize; resize();

        function drawMicio(x, y, scale) {
            ctx.save();
            ctx.translate(x, y);
            
            // Animacija dihanja
            const breath = Math.sin(Date.now() / 300) * 2;
            const micioSize = (30 - (level * 2)) + breath; // Postaja manjši/bolj fit z leveli
            const widthMult = level < 3 ? 1.5 : 0.8; // LVL 1 je "chunky"

            // Telo
            ctx.fillStyle = "#222";
            ctx.shadowBlur = 15;
            ctx.shadowColor = isLong ? "#00ff88" : "#ff3366";
            ctx.beginPath();
            ctx.ellipse(0, 0, micioSize * widthMult, micioSize, 0, 0, Math.PI * 2);
            ctx.fill();

            // Oči (Neon)
            ctx.fillStyle = "#fff";
            ctx.beginPath();
            ctx.arc(-micioSize/2, -micioSize/4, 4, 0, Math.PI*2);
            ctx.arc(micioSize/2, -micioSize/4, 4, 0, Math.PI*2);
            ctx.fill();

            // Rep (Animiran)
            ctx.strokeStyle = "#222";
            ctx.lineWidth = 5;
            ctx.beginPath();
            ctx.moveTo(micioSize * widthMult, 0);
            ctx.quadraticCurveTo(micioSize*2, Math.sin(Date.now()/200)*20, micioSize*1.5, -20);
            ctx.stroke();

            ctx.restore();
        }

        function render() {
            ctx.fillStyle = "#050608";
            ctx.fillRect(0, 0, width, height);

            // Cyber Grid
            ctx.strokeStyle = "#111827";
            for(let i=0; i<width; i+=50) { ctx.beginPath(); ctx.moveTo(i,0); ctx.lineTo(i,height); ctx.stroke(); }
            for(let i=0; i<height; i+=50) { ctx.beginPath(); ctx.moveTo(0,i); ctx.lineTo(width,i); ctx.stroke(); }

            if (points.length > 2) {
                const min = Math.min(...points), max = Math.max(...points), range = (max-min)||10;
                const getY = (p) => height/2 + (height/3) * (-(p - (min+max)/2) / (range/2));

                // 3D Path Effect
                ctx.beginPath();
                ctx.lineWidth = 10;
                ctx.strokeStyle = "rgba(31, 41, 55, 0.3)";
                points.forEach((p, i) => { 
                    const x = i * (width/100);
                    if(i==0) ctx.moveTo(x, getY(p)+10); else ctx.lineTo(x, getY(p)+10);
                });
                ctx.stroke();

                // Main Price Line
                ctx.beginPath();
                ctx.lineWidth = 3;
                ctx.strokeStyle = isLong ? "#00ff88" : "#ff3366";
                points.forEach((p, i) => { 
                    const x = i * (width/100);
                    if(i==0) ctx.moveTo(x, getY(p)); else ctx.lineTo(x, getY(p));
                });
                ctx.stroke();

                // Micio Positioning
                const targetY = getY(points[points.length-1]) + (isLong ? -50 : 50);
                catY += (targetY - catY) * 0.1;
                drawMicio( (points.length-1) * (width/100), catY);
            }
            requestAnimationFrame(render);
        }

        window.onmousedown = () => isLong = true;
        window.onmouseup = () => isLong = false;
        window.ontouchstart = (e) => { e.preventDefault(); isLong = true; };
        window.ontouchend = () => isLong = false;

        render();
    </script>
</body>
</html>
